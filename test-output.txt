
> rabbitmq-production-ready@1.0.1 test
> node --test test/*.test.js

TAP version 13
# Subtest: should create client instance
ok 1 - should create client instance
  ---
  duration_ms: 1.355291
  type: 'test'
  ...
# Subtest: should validate connection string
ok 2 - should validate connection string
  ---
  duration_ms: 0.239958
  type: 'test'
  ...
# Subtest: should validate retry config
ok 3 - should validate retry config
  ---
  duration_ms: 0.102917
  type: 'test'
  ...
# Subtest: should validate DLQ config
ok 4 - should validate DLQ config
  ---
  duration_ms: 0.065458
  type: 'test'
  ...
# Subtest: should have DLQ disabled by default
ok 5 - should have DLQ disabled by default
  ---
  duration_ms: 0.223542
  type: 'test'
  ...
# Subtest: should enable DLQ when explicitly set
ok 6 - should enable DLQ when explicitly set
  ---
  duration_ms: 0.215458
  type: 'test'
  ...
# Subtest: should have default retry enabled
ok 7 - should have default retry enabled
  ---
  duration_ms: 0.202833
  type: 'test'
  ...
# Subtest: should generate correlation ID
ok 8 - should generate correlation ID
  ---
  duration_ms: 0.194542
  type: 'test'
  ...
# Subtest: should get correlation ID from options
ok 9 - should get correlation ID from options
  ---
  duration_ms: 0.302542
  type: 'test'
  ...
# Subtest: should calculate retry delay
ok 10 - should calculate retry delay
  ---
  duration_ms: 0.510625
  type: 'test'
  ...
# Subtest: should cap retry delay at max
ok 11 - should cap retry delay at max
  ---
  duration_ms: 0.30275
  type: 'test'
  ...
# Subtest: should get connection info
ok 12 - should get connection info
  ---
  duration_ms: 0.526416
  type: 'test'
  ...
# Subtest: should get all consumers
ok 13 - should get all consumers
  ---
  duration_ms: 0.151083
  type: 'test'
  ...
# Subtest: should get metrics
ok 14 - should get metrics
  ---
  duration_ms: 0.144792
  type: 'test'
  ...
# Subtest: should reset metrics
ok 15 - should reset metrics
  ---
  duration_ms: 0.096542
  type: 'test'
  ...
# Subtest: should get DLQ name
ok 16 - should get DLQ name
  ---
  duration_ms: 0.100375
  type: 'test'
  ...
# Subtest: should have hooks support
ok 17 - should have hooks support
  ---
  duration_ms: 0.078416
  type: 'test'
  ...
# Subtest: should support custom serializer
ok 18 - should support custom serializer
  ---
  duration_ms: 0.140125
  type: 'test'
  ...
# Subtest: should support custom deserializer
ok 19 - should support custom deserializer
  ---
  duration_ms: 0.090833
  type: 'test'
  ...
# Subtest: should support tracing configuration
ok 20 - should support tracing configuration
  ---
  duration_ms: 0.073125
  type: 'test'
  ...
# Subtest: should validate serializer
ok 21 - should validate serializer
  ---
  duration_ms: 0.047834
  type: 'test'
  ...
# Subtest: should validate deserializer
ok 22 - should validate deserializer
  ---
  duration_ms: 0.043833
  type: 'test'
  ...
# Subtest: should validate tracing config
ok 23 - should validate tracing config
  ---
  duration_ms: 0.115333
  type: 'test'
  ...
# Subtest: should use default serializer
ok 24 - should use default serializer
  ---
  duration_ms: 0.087209
  type: 'test'
  ...
# Subtest: should use default deserializer
ok 25 - should use default deserializer
  ---
  duration_ms: 0.353041
  type: 'test'
  ...
# Subtest: should auto-generate trace ID when tracing enabled
ok 26 - should auto-generate trace ID when tracing enabled
  ---
  duration_ms: 0.093166
  type: 'test'
  ...
# Subtest: should use trace ID from context when available
ok 27 - should use trace ID from context when available
  ---
  duration_ms: 0.065959
  type: 'test'
  ...
# Subtest: should use trace ID from options when provided
ok 28 - should use trace ID from options when provided
  ---
  duration_ms: 0.481958
  type: 'test'
  ...
# Subtest: should support custom trace ID generator
ok 29 - should support custom trace ID generator
  ---
  duration_ms: 0.149209
  type: 'test'
  ...
# {"level":30,"time":1763483794512,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# {"level":30,"time":1763483794519,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483794519,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483794519,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483794521,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483794521,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should connect and disconnect
ok 30 - should connect and disconnect
  ---
  duration_ms: 18.951042
  type: 'test'
  ...
# {"level":30,"time":1763483794521,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483794525,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483794528,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_queue_1763483794526","consumerTag":"amq.ctag-VGtomCZ7v2TNSPdeFZdgAg","msg":"Consumer started"}
# {"level":30,"time":1763483794732,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483794733,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483794735,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_queue_1763483794526","consumerTag":"amq.ctag-VGtomCZ7v2TNSPdeFZdgAg","msg":"Consumer stopped"}
# {"level":30,"time":1763483794737,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483794737,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should publish and consume messages
ok 31 - should publish and consume messages
  ---
  duration_ms: 215.634208
  type: 'test'
  ...
# {"level":30,"time":1763483794737,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483794744,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483794748,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483794744","consumerTag":"amq.ctag-FtzWIl2wnmujyRVXroraxQ","msg":"Consumer started"}
# {"level":50,"time":1763483794854,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Simulated error","stack":"Error: Simulated error\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration-full.test.js:125:15)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_retry_1763483794744","correlationId":"1763483794850-xh1x9a1gt","attempt":1,"msg":"Error processing message"}
# {"level":30,"time":1763483794855,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483794744","correlationId":"1763483794850-xh1x9a1gt","retryCount":1,"msg":"Message requeued for retry"}
# {"level":30,"time":1763483795053,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483795053,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483795057,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483794744","consumerTag":"amq.ctag-FtzWIl2wnmujyRVXroraxQ","msg":"Consumer stopped"}
# {"level":30,"time":1763483795060,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483795062,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should handle retry on consume error
ok 32 - should handle retry on consume error
  ---
  duration_ms: 323.881458
  type: 'test'
  ...
# {"level":30,"time":1763483795060,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483795072,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483795090,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483795072","consumerTag":"amq.ctag-ee82OUdD6m-UzUTcBFez1A","msg":"Consumer started"}
# {"level":50,"time":1763483795091,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Always fail","stack":"Error: Always fail\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration-full.test.js:178:13)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_dlq_1763483795072","correlationId":"1763483795090-w0mrhvjze","attempt":1,"msg":"Error processing message"}
# {"level":30,"time":1763483795091,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483795072","correlationId":"1763483795090-w0mrhvjze","retryCount":1,"msg":"Message requeued for retry"}
# {"level":50,"time":1763483795091,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Always fail","stack":"Error: Always fail\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration-full.test.js:178:13)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_dlq_1763483795072","correlationId":"1763483795090-w0mrhvjze","attempt":2,"msg":"Error processing message"}
# {"level":40,"time":1763483795094,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483795072","correlationId":"1763483795090-w0mrhvjze","dlq":"dlq.test_dlq_1763483795072","error":"Always fail","msg":"Message sent to DLQ"}
# {"level":40,"time":1763483795094,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483795072","correlationId":"1763483795090-w0mrhvjze","retryCount":1,"msg":"Message sent to DLQ"}
# {"level":30,"time":1763483796093,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483796093,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483796094,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483795072","consumerTag":"amq.ctag-ee82OUdD6m-UzUTcBFez1A","msg":"Consumer stopped"}
# {"level":30,"time":1763483796096,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483796096,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should send to DLQ when retries exhausted
ok 33 - should send to DLQ when retries exhausted
  ---
  duration_ms: 1034.802542
  type: 'test'
  ...
# {"level":30,"time":1763483796096,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483796100,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483796103,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_metrics_1763483796100","consumerTag":"amq.ctag-WLLSg0F1KN7icKBGPzMhug","msg":"Consumer started"}
# {"level":30,"time":1763483796307,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483796307,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483796309,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_metrics_1763483796100","consumerTag":"amq.ctag-WLLSg0F1KN7icKBGPzMhug","msg":"Consumer stopped"}
# {"level":30,"time":1763483796311,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483796311,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should collect metrics
ok 34 - should collect metrics
  ---
  duration_ms: 214.91925
  type: 'test'
  ...
# {"level":30,"time":1763483796311,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483796317,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483796317,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483796317,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483796318,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483796318,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should perform health check
ok 35 - should perform health check
  ---
  duration_ms: 7.5275
  type: 'test'
  ...
# {"level":30,"time":1763483796318,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483796323,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":40,"time":1763483796426,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"RabbitMQ connection closed"}
# {"level":30,"time":1763483796426,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","attempt":1,"delay":100,"msg":"Scheduling reconnect"}
# {"level":30,"time":1763483796528,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# {"level":30,"time":1763483796542,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Reconnected to RabbitMQ"}
# {"level":30,"time":1763483796928,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483796928,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483796934,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483796936,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should handle reconnection
ok 36 - should handle reconnection
  ---
  duration_ms: 616.099125
  type: 'test'
  ...
# {"level":30,"time":1763483796934,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483796949,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483796957,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_serializer_1763483796950","consumerTag":"amq.ctag-wv-Cq5SvbQgQYuWosC6EYw","msg":"Consumer started"}
# {"level":30,"time":1763483797160,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483797160,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483797162,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_serializer_1763483796950","consumerTag":"amq.ctag-wv-Cq5SvbQgQYuWosC6EYw","msg":"Consumer stopped"}
# {"level":30,"time":1763483797163,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483797164,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should use custom serializer/deserializer
ok 37 - should use custom serializer/deserializer
  ---
  duration_ms: 228.821583
  type: 'test'
  ...
# {"level":30,"time":1763483797163,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483797170,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483797173,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_tracing_1763483797170","consumerTag":"amq.ctag-0TcXVv9lYWZYweVJgkCx3Q","msg":"Consumer started"}
# {"level":30,"time":1763483797376,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483797376,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483797378,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_tracing_1763483797170","consumerTag":"amq.ctag-0TcXVv9lYWZYweVJgkCx3Q","msg":"Consumer stopped"}
# {"level":30,"time":1763483797380,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483797381,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should propagate trace ID through messages
ok 38 - should propagate trace ID through messages
  ---
  duration_ms: 216.73475
  type: 'test'
  ...
# {"level":30,"time":1763483797380,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483797390,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483797395,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_trace_context_1763483797390","consumerTag":"amq.ctag-hxQ9TC3vTMOuK6qz2e5KXg","msg":"Consumer started"}
# {"level":30,"time":1763483797599,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483797599,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483797601,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_trace_context_1763483797390","consumerTag":"amq.ctag-hxQ9TC3vTMOuK6qz2e5KXg","msg":"Consumer stopped"}
# {"level":30,"time":1763483797604,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# Subtest: should set trace context from message headers
ok 39 - should set trace context from message headers
  ---
  duration_ms: 223.376958
  type: 'test'
  ...
# {"level":30,"time":1763483797604,"pid":27027,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483794512,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# {"level":30,"time":1763483794519,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483794519,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483794519,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483794521,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483794521,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should connect and disconnect
ok 40 - should connect and disconnect
  ---
  duration_ms: 19.054792
  type: 'test'
  ...
# {"level":30,"time":1763483794521,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483794525,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483794528,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_queue_1763483794525","consumerTag":"amq.ctag-1F34UZkyN7_88eHPJpM-9g","msg":"Consumer started"}
# {"level":30,"time":1763483795530,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483795530,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483795533,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_queue_1763483794525","consumerTag":"amq.ctag-1F34UZkyN7_88eHPJpM-9g","msg":"Consumer stopped"}
# {"level":30,"time":1763483795536,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483795536,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should publish and consume messages
ok 41 - should publish and consume messages
  ---
  duration_ms: 1014.569584
  type: 'test'
  ...
# {"level":30,"time":1763483795536,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483795544,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483795548,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483795544","consumerTag":"amq.ctag-G8U1D3sh2JH9OmaTWfdpkw","msg":"Consumer started"}
# {"level":50,"time":1763483795549,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Simulated error","stack":"Error: Simulated error\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration.test.js:113:15)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_retry_1763483795544","correlationId":"1763483795548-0pbtwqwck","attempt":1,"msg":"Error processing message"}
# {"level":30,"time":1763483795549,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483795544","correlationId":"1763483795548-0pbtwqwck","retryCount":1,"msg":"Message requeued for retry"}
# {"level":30,"time":1763483796048,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483796048,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483796050,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483795544","consumerTag":"amq.ctag-G8U1D3sh2JH9OmaTWfdpkw","msg":"Consumer stopped"}
# {"level":30,"time":1763483796052,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483796053,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should handle retry on consume error
ok 42 - should handle retry on consume error
  ---
  duration_ms: 516.635583
  type: 'test'
  ...
# {"level":30,"time":1763483796052,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483796057,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483796064,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483796057","consumerTag":"amq.ctag-v1NmldhSFr_xHo_g_tnvzA","msg":"Consumer started"}
# {"level":50,"time":1763483796065,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Always fail","stack":"Error: Always fail\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration.test.js:158:13)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_dlq_1763483796057","correlationId":"1763483796064-7mqy7qs90","attempt":1,"msg":"Error processing message"}
# {"level":30,"time":1763483796065,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483796057","correlationId":"1763483796064-7mqy7qs90","retryCount":1,"msg":"Message requeued for retry"}
# {"level":50,"time":1763483796065,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Always fail","stack":"Error: Always fail\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration.test.js:158:13)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_dlq_1763483796057","correlationId":"1763483796064-7mqy7qs90","attempt":2,"msg":"Error processing message"}
# {"level":40,"time":1763483796067,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483796057","correlationId":"1763483796064-7mqy7qs90","dlq":"dlq.test_dlq_1763483796057","error":"Always fail","msg":"Message sent to DLQ"}
# {"level":40,"time":1763483796067,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483796057","correlationId":"1763483796064-7mqy7qs90","retryCount":1,"msg":"Message sent to DLQ"}
# {"level":30,"time":1763483797067,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483797067,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483797069,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483796057","consumerTag":"amq.ctag-v1NmldhSFr_xHo_g_tnvzA","msg":"Consumer stopped"}
# {"level":30,"time":1763483797071,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483797072,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should send to DLQ when retries exhausted
ok 43 - should send to DLQ when retries exhausted
  ---
  duration_ms: 1018.893208
  type: 'test'
  ...
# {"level":30,"time":1763483797071,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483797080,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483797086,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_metrics_1763483797080","consumerTag":"amq.ctag-PdRwfTVuBve_76nxzzRffQ","msg":"Consumer started"}
# {"level":30,"time":1763483797589,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483797589,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483797592,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_metrics_1763483797080","consumerTag":"amq.ctag-PdRwfTVuBve_76nxzzRffQ","msg":"Consumer stopped"}
# {"level":30,"time":1763483797598,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483797600,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should collect metrics
ok 44 - should collect metrics
  ---
  duration_ms: 526.810792
  type: 'test'
  ...
# {"level":30,"time":1763483797598,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483797611,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483797611,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483797611,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483797613,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483797613,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should perform health check
ok 45 - should perform health check
  ---
  duration_ms: 14.369459
  type: 'test'
  ...
# {"level":30,"time":1763483797613,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483797619,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":40,"time":1763483797620,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"RabbitMQ connection closed"}
# {"level":30,"time":1763483797620,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","attempt":1,"delay":100,"msg":"Scheduling reconnect"}
# {"level":30,"time":1763483797722,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# {"level":30,"time":1763483797736,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Reconnected to RabbitMQ"}
# {"level":30,"time":1763483798121,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483798121,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483798125,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# Subtest: should handle reconnection
ok 46 - should handle reconnection
  ---
  duration_ms: 512.432
  type: 'test'
  ...
# {"level":30,"time":1763483798125,"pid":27028,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
1..46
# tests 46
# suites 0
# pass 46
# fail 0
# cancelled 0
# skipped 0
# todo 0
# duration_ms 5074.114458
