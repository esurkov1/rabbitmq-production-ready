
> rabbitmq-production-ready@1.0.1 test
> node --test test/*.test.js

TAP version 13
# Subtest: should create client instance
ok 1 - should create client instance
  ---
  duration_ms: 1.44725
  type: 'test'
  ...
# Subtest: should validate connection string
ok 2 - should validate connection string
  ---
  duration_ms: 0.241
  type: 'test'
  ...
# Subtest: should validate retry config
ok 3 - should validate retry config
  ---
  duration_ms: 0.106084
  type: 'test'
  ...
# Subtest: should validate DLQ config
ok 4 - should validate DLQ config
  ---
  duration_ms: 0.06475
  type: 'test'
  ...
# Subtest: should have DLQ disabled by default
ok 5 - should have DLQ disabled by default
  ---
  duration_ms: 0.221
  type: 'test'
  ...
# Subtest: should enable DLQ when explicitly set
ok 6 - should enable DLQ when explicitly set
  ---
  duration_ms: 0.214084
  type: 'test'
  ...
# Subtest: should have default retry enabled
ok 7 - should have default retry enabled
  ---
  duration_ms: 0.204417
  type: 'test'
  ...
# Subtest: should generate correlation ID
ok 8 - should generate correlation ID
  ---
  duration_ms: 0.204166
  type: 'test'
  ...
# Subtest: should get correlation ID from options
ok 9 - should get correlation ID from options
  ---
  duration_ms: 0.303834
  type: 'test'
  ...
# Subtest: should calculate retry delay
ok 10 - should calculate retry delay
  ---
  duration_ms: 0.357458
  type: 'test'
  ...
# Subtest: should cap retry delay at max
ok 11 - should cap retry delay at max
  ---
  duration_ms: 0.229667
  type: 'test'
  ...
# Subtest: should get connection info
ok 12 - should get connection info
  ---
  duration_ms: 0.569125
  type: 'test'
  ...
# Subtest: should get all consumers
ok 13 - should get all consumers
  ---
  duration_ms: 0.240125
  type: 'test'
  ...
# Subtest: should get metrics
ok 14 - should get metrics
  ---
  duration_ms: 0.182042
  type: 'test'
  ...
# Subtest: should reset metrics
ok 15 - should reset metrics
  ---
  duration_ms: 0.122875
  type: 'test'
  ...
# Subtest: should get DLQ name
ok 16 - should get DLQ name
  ---
  duration_ms: 0.103291
  type: 'test'
  ...
# Subtest: should have hooks support
ok 17 - should have hooks support
  ---
  duration_ms: 0.087292
  type: 'test'
  ...
# Subtest: should support custom serializer
ok 18 - should support custom serializer
  ---
  duration_ms: 0.139917
  type: 'test'
  ...
# Subtest: should support custom deserializer
ok 19 - should support custom deserializer
  ---
  duration_ms: 0.092875
  type: 'test'
  ...
# Subtest: should support tracing configuration
ok 20 - should support tracing configuration
  ---
  duration_ms: 0.081959
  type: 'test'
  ...
# Subtest: should validate serializer
ok 21 - should validate serializer
  ---
  duration_ms: 0.054458
  type: 'test'
  ...
# Subtest: should validate deserializer
ok 22 - should validate deserializer
  ---
  duration_ms: 0.046667
  type: 'test'
  ...
# Subtest: should validate tracing config
ok 23 - should validate tracing config
  ---
  duration_ms: 0.132334
  type: 'test'
  ...
# Subtest: should use default serializer
ok 24 - should use default serializer
  ---
  duration_ms: 0.0955
  type: 'test'
  ...
# Subtest: should use default deserializer
ok 25 - should use default deserializer
  ---
  duration_ms: 0.376208
  type: 'test'
  ...
# Subtest: should auto-generate trace ID when tracing enabled
ok 26 - should auto-generate trace ID when tracing enabled
  ---
  duration_ms: 0.104542
  type: 'test'
  ...
# Subtest: should use trace ID from context when available
ok 27 - should use trace ID from context when available
  ---
  duration_ms: 0.072958
  type: 'test'
  ...
# Subtest: should use trace ID from options when provided
ok 28 - should use trace ID from options when provided
  ---
  duration_ms: 0.565208
  type: 'test'
  ...
# Subtest: should support custom trace ID generator
ok 29 - should support custom trace ID generator
  ---
  duration_ms: 0.148083
  type: 'test'
  ...
# {"level":30,"time":1763483956088,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# {"level":30,"time":1763483956093,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483956093,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483956093,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483956095,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483956098,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should connect and disconnect
ok 30 - should connect and disconnect
  ---
  duration_ms: 17.134084
  type: 'test'
  ...
# {"level":30,"time":1763483956095,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483956101,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483956105,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_queue_1763483956102","consumerTag":"amq.ctag-f6XOVY2Uezs0-Q2Yp2YssA","msg":"Consumer started"}
# {"level":30,"time":1763483956361,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483956362,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483956365,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_queue_1763483956102","consumerTag":"amq.ctag-f6XOVY2Uezs0-Q2Yp2YssA","msg":"Consumer stopped"}
# {"level":30,"time":1763483956367,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483956368,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should publish and consume messages
ok 31 - should publish and consume messages
  ---
  duration_ms: 270.254792
  type: 'test'
  ...
# {"level":30,"time":1763483956367,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483956379,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483956383,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483956379","consumerTag":"amq.ctag-uq6i_j7TYVbLhI6YmM8Sig","msg":"Consumer started"}
# {"level":50,"time":1763483956488,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Simulated error","stack":"Error: Simulated error\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration-full.test.js:135:15)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_retry_1763483956379","correlationId":"1763483956485-9wy9xx610","attempt":1,"msg":"Error processing message"}
# {"level":30,"time":1763483956489,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483956379","correlationId":"1763483956485-9wy9xx610","retryCount":1,"msg":"Message requeued for retry"}
# {"level":30,"time":1763483956687,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483956687,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483956690,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483956379","consumerTag":"amq.ctag-uq6i_j7TYVbLhI6YmM8Sig","msg":"Consumer stopped"}
# {"level":30,"time":1763483956692,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483956693,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should handle retry on consume error
ok 32 - should handle retry on consume error
  ---
  duration_ms: 324.855334
  type: 'test'
  ...
# {"level":30,"time":1763483956692,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483956702,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483956718,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483956702","consumerTag":"amq.ctag-jSvpFQrGRDwkumH41SxpnQ","msg":"Consumer started"}
# {"level":50,"time":1763483956720,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Always fail","stack":"Error: Always fail\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration-full.test.js:188:13)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_dlq_1763483956702","correlationId":"1763483956718-y96sm0w3o","attempt":1,"msg":"Error processing message"}
# {"level":30,"time":1763483956720,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483956702","correlationId":"1763483956718-y96sm0w3o","retryCount":1,"msg":"Message requeued for retry"}
# {"level":50,"time":1763483956721,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Always fail","stack":"Error: Always fail\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration-full.test.js:188:13)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_dlq_1763483956702","correlationId":"1763483956718-y96sm0w3o","attempt":2,"msg":"Error processing message"}
# {"level":40,"time":1763483956726,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483956702","correlationId":"1763483956718-y96sm0w3o","dlq":"dlq.test_dlq_1763483956702","error":"Always fail","msg":"Message sent to DLQ"}
# {"level":40,"time":1763483956726,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483956702","correlationId":"1763483956718-y96sm0w3o","retryCount":1,"msg":"Message sent to DLQ"}
# {"level":30,"time":1763483957722,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483957722,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483957723,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483956702","consumerTag":"amq.ctag-jSvpFQrGRDwkumH41SxpnQ","msg":"Consumer stopped"}
# {"level":30,"time":1763483957726,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483957727,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should send to DLQ when retries exhausted
ok 33 - should send to DLQ when retries exhausted
  ---
  duration_ms: 1034.08425
  type: 'test'
  ...
# {"level":30,"time":1763483957726,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483957736,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483957741,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_metrics_1763483957736","consumerTag":"amq.ctag-1FDoM9ytXeRp9Limu5J5qA","msg":"Consumer started"}
# {"level":30,"time":1763483957945,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483957945,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483957947,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_metrics_1763483957736","consumerTag":"amq.ctag-1FDoM9ytXeRp9Limu5J5qA","msg":"Consumer stopped"}
# {"level":30,"time":1763483957949,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483957949,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should collect metrics
ok 34 - should collect metrics
  ---
  duration_ms: 222.359375
  type: 'test'
  ...
# {"level":30,"time":1763483957949,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483957955,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483957955,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483957955,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483957957,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483957957,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should perform health check
ok 35 - should perform health check
  ---
  duration_ms: 7.832042
  type: 'test'
  ...
# {"level":30,"time":1763483957957,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483957963,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":40,"time":1763483958066,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"RabbitMQ connection closed"}
# {"level":30,"time":1763483958067,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","attempt":1,"delay":100,"msg":"Scheduling reconnect"}
# {"level":30,"time":1763483958169,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# {"level":30,"time":1763483958186,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Reconnected to RabbitMQ"}
# {"level":30,"time":1763483958568,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483958568,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483958574,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483958576,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should handle reconnection
ok 36 - should handle reconnection
  ---
  duration_ms: 617.497542
  type: 'test'
  ...
# {"level":30,"time":1763483958574,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483958587,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483958593,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_serializer_1763483958587","consumerTag":"amq.ctag-Y9cvwaIcs_zwgapLWuT2OA","msg":"Consumer started"}
# {"level":30,"time":1763483958796,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483958796,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483958797,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_serializer_1763483958587","consumerTag":"amq.ctag-Y9cvwaIcs_zwgapLWuT2OA","msg":"Consumer stopped"}
# {"level":30,"time":1763483958800,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483958802,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should use custom serializer/deserializer
ok 37 - should use custom serializer/deserializer
  ---
  duration_ms: 225.557542
  type: 'test'
  ...
# {"level":30,"time":1763483958800,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483958808,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483958812,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_tracing_1763483958808","consumerTag":"amq.ctag-iweopc6uFDGtNSDnUHUMVQ","msg":"Consumer started"}
# {"level":30,"time":1763483959016,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483959016,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483959019,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_tracing_1763483958808","consumerTag":"amq.ctag-iweopc6uFDGtNSDnUHUMVQ","msg":"Consumer stopped"}
# {"level":30,"time":1763483959021,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483959024,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should propagate trace ID through messages
ok 38 - should propagate trace ID through messages
  ---
  duration_ms: 221.881333
  type: 'test'
  ...
# {"level":30,"time":1763483959022,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483959034,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483959040,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_trace_context_1763483959034","consumerTag":"amq.ctag-4RT42T_4U9mxaEC5PrAjvA","msg":"Consumer started"}
# {"level":30,"time":1763483959244,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483959244,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483959246,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_trace_context_1763483959034","consumerTag":"amq.ctag-4RT42T_4U9mxaEC5PrAjvA","msg":"Consumer stopped"}
# {"level":30,"time":1763483959247,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# Subtest: should set trace context from message headers
ok 39 - should set trace context from message headers
  ---
  duration_ms: 225.417458
  type: 'test'
  ...
# {"level":30,"time":1763483959248,"pid":35930,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483956087,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# {"level":30,"time":1763483956093,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483956093,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483956093,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483956095,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483956097,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should connect and disconnect
ok 40 - should connect and disconnect
  ---
  duration_ms: 16.089875
  type: 'test'
  ...
# {"level":30,"time":1763483956095,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483956101,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483956104,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_queue_1763483956101","consumerTag":"amq.ctag-sH1amNGJlPX_aXpWZyw8Ig","msg":"Consumer started"}
# {"level":30,"time":1763483957105,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483957105,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483957108,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_queue_1763483956101","consumerTag":"amq.ctag-sH1amNGJlPX_aXpWZyw8Ig","msg":"Consumer stopped"}
# {"level":30,"time":1763483957110,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483957110,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should publish and consume messages
ok 41 - should publish and consume messages
  ---
  duration_ms: 1013.344375
  type: 'test'
  ...
# {"level":30,"time":1763483957110,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483957115,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483957118,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483957115","consumerTag":"amq.ctag-DPCDoVlBPgmoeeWJ94DdyQ","msg":"Consumer started"}
# {"level":50,"time":1763483957119,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Simulated error","stack":"Error: Simulated error\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration.test.js:113:15)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_retry_1763483957115","correlationId":"1763483957119-1w65dml33","attempt":1,"msg":"Error processing message"}
# {"level":30,"time":1763483957120,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483957115","correlationId":"1763483957119-1w65dml33","retryCount":1,"msg":"Message requeued for retry"}
# {"level":30,"time":1763483957620,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483957620,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483957624,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_retry_1763483957115","consumerTag":"amq.ctag-DPCDoVlBPgmoeeWJ94DdyQ","msg":"Consumer stopped"}
# {"level":30,"time":1763483957628,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483957630,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should handle retry on consume error
ok 42 - should handle retry on consume error
  ---
  duration_ms: 518.669042
  type: 'test'
  ...
# {"level":30,"time":1763483957628,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483957643,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483957664,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483957643","consumerTag":"amq.ctag-Gx6GigMusY-7vz-mLbLJMQ","msg":"Consumer started"}
# {"level":50,"time":1763483957666,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Always fail","stack":"Error: Always fail\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration.test.js:158:13)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_dlq_1763483957643","correlationId":"1763483957665-58fd3icv6","attempt":1,"msg":"Error processing message"}
# {"level":30,"time":1763483957667,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483957643","correlationId":"1763483957665-58fd3icv6","retryCount":1,"msg":"Message requeued for retry"}
# {"level":50,"time":1763483957668,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","err":{"type":"Error","message":"Always fail","stack":"Error: Always fail\\n    at client.consume.maxRetries (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/test/integration.test.js:158:13)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/lib/RabbitMQClient.js:1467:17\\n    at Channel.dispatchMessage (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:489:14)\\n    at Channel.handleDelivery (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:498:17)\\n    at Channel.emit (node:events:519:28)\\n    at /Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:395:10\\n    at Channel.content (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:448:9)\\n    at Channel.acceptMessageFrame (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:232:33)\\n    at Channel.accept (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/channel.js:302:19)\\n    at Connection.mainAccept [as accept] (/Users/esurkov1/Desktop/Разработка/Packages/rabbitmq-production-ready/node_modules/amqplib/lib/connection.js:579:33)"},"queue":"test_dlq_1763483957643","correlationId":"1763483957665-58fd3icv6","attempt":2,"msg":"Error processing message"}
# {"level":40,"time":1763483957673,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483957643","correlationId":"1763483957665-58fd3icv6","dlq":"dlq.test_dlq_1763483957643","error":"Always fail","msg":"Message sent to DLQ"}
# {"level":40,"time":1763483957673,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483957643","correlationId":"1763483957665-58fd3icv6","retryCount":1,"msg":"Message sent to DLQ"}
# {"level":30,"time":1763483958669,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483958669,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483958673,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_dlq_1763483957643","consumerTag":"amq.ctag-Gx6GigMusY-7vz-mLbLJMQ","msg":"Consumer stopped"}
# {"level":30,"time":1763483958676,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483958677,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should send to DLQ when retries exhausted
ok 43 - should send to DLQ when retries exhausted
  ---
  duration_ms: 1047.678958
  type: 'test'
  ...
# {"level":30,"time":1763483958676,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483958685,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483958690,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_metrics_1763483958685","consumerTag":"amq.ctag-KcsAZC7A6hOBXxmVGDXsjQ","msg":"Consumer started"}
# {"level":30,"time":1763483959192,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483959193,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":1,"msg":"Stopping consumers"}
# {"level":30,"time":1763483959195,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","queue":"test_metrics_1763483958685","consumerTag":"amq.ctag-KcsAZC7A6hOBXxmVGDXsjQ","msg":"Consumer stopped"}
# {"level":30,"time":1763483959200,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483959201,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should collect metrics
ok 44 - should collect metrics
  ---
  duration_ms: 523.546209
  type: 'test'
  ...
# {"level":30,"time":1763483959200,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483959214,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":30,"time":1763483959214,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483959214,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483959216,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# {"level":30,"time":1763483959217,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# Subtest: should perform health check
ok 45 - should perform health check
  ---
  duration_ms: 16.043416
  type: 'test'
  ...
# {"level":30,"time":1763483959216,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
# {"level":30,"time":1763483959224,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connected to RabbitMQ"}
# {"level":40,"time":1763483959225,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"RabbitMQ connection closed"}
# {"level":30,"time":1763483959225,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","attempt":1,"delay":100,"msg":"Scheduling reconnect"}
# {"level":30,"time":1763483959327,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connecting to RabbitMQ"}
# {"level":30,"time":1763483959336,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Reconnected to RabbitMQ"}
# {"level":30,"time":1763483959726,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Starting graceful shutdown"}
# {"level":30,"time":1763483959726,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","count":0,"msg":"Stopping consumers"}
# {"level":30,"time":1763483959732,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Connection closed successfully"}
# Subtest: should handle reconnection
ok 46 - should handle reconnection
  ---
  duration_ms: 515.3885
  type: 'test'
  ...
# {"level":30,"time":1763483959732,"pid":35931,"hostname":"MBP--Esurkov1.lan","name":"RabbitMQClient","msg":"Graceful shutdown completed"}
1..46
# tests 46
# suites 0
# pass 46
# fail 0
# cancelled 0
# skipped 0
# todo 0
# duration_ms 5069.438167
